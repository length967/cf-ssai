name = "cf-ssai-decision"
main = "src/decision-worker.ts"
compatibility_date = "2025-10-01"
workers_dev = true

# D1 Database for ad pods and channel configuration
[[d1_databases]]
binding = "DB"
database_name = "ssai-admin"
database_id = "0302f8ab-e592-4fa6-8bbf-7371759da6ed"

# R2 bucket for transcoded HLS ads
[[r2_buckets]]
binding = "R2"
bucket_name = "ssai-ads"

# KV for decision caching
[[kv_namespaces]]
binding = "DECISION_CACHE"
id = "4beba810f4d141e7be9e3298c7b07944"

# Service binding to VAST parser worker
[[services]]
binding = "VAST_PARSER"
service = "cf-ssai-vast-parser"

# Configuration
[vars]
AD_POD_BASE = "https://pub-24423d0273094578a7f498bd462c2e20.r2.dev/transcoded-ads"
DECISION_TIMEOUT_MS = "2000"
CACHE_DECISION_TTL = "0"  # Disabled for testing - set to 60 in production
# VAST_URL = "https://example.com/vast.xml"  # Optional: Static VAST URL for testing

# Secrets (optional - for external ad API)
# AD_DECISION_API_URL - set via: wrangler secret put AD_DECISION_API_URL
# AD_DECISION_API_KEY - set via: wrangler secret put AD_DECISION_API_KEY

# Observability
[observability]
enabled = true

# Sampling rates for decision worker (service-to-service calls)
[observability.logs]
enabled = true
head_sampling_rate = 1.0  # 100% for debugging - reduce to 0.05 (5%) in production

[observability.traces]
enabled = true
head_sampling_rate = 1.0  # 100% for debugging - reduce to 0.15 (15%) in production

