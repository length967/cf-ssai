name = "cf-ssai"
main = "src/manifest-worker.ts"
compatibility_date = "2025-10-01"
workers_dev = true

# ---- Environment bindings (adjust names/ids) ----
# Durable Object to coordinate each channel's live state
[[durable_objects.bindings]]
name = "CHANNEL_DO"
class_name = "ChannelDO"

# Migrations for the DO
[[migrations]]
tag = "v1"
new_classes = ["ChannelDO"]

# R2 bucket for ads (pre-normalized ABR pods)
[[r2_buckets]]
binding = "ADS_BUCKET"
bucket_name = "ads-bucket"

# R2 bucket for ad source files and transcoded HLS
[[r2_buckets]]
binding = "R2"
bucket_name = "ssai-ads"

# D1 Database for per-channel multi-tenant configuration
[[d1_databases]]
binding = "DB"
database_name = "ssai-admin"
database_id = "0302f8ab-e592-4fa6-8bbf-7371759da6ed"

# KV for caching channel configuration (reduces D1 queries, 5-minute TTL)
[[kv_namespaces]]
binding = "CHANNEL_CONFIG_CACHE"
id = "f03509ea56964ca3ad062b116a683dc4"

# Queues for server-side beacons
# Producer only - consumer is in separate beacon-consumer-worker
[[queues.producers]]
binding = "BEACON_QUEUE"
queue = "beacon-queue"

# Queue for transcode jobs
[[queues.producers]]
binding = "TRANSCODE_QUEUE"
queue = "transcode-queue"

# Service bindings for worker-to-worker communication
[[services]]
binding = "DECISION"
service = "cf-ssai-decision"

# Configuration
[vars]
# Global fallback defaults - these are overridden by per-channel configuration in the database
ORIGIN_VARIANT_BASE = "https://pub-24423d0273094578a7f498bd462c2e20.r2.dev/origin"
AD_POD_BASE = "https://pub-24423d0273094578a7f498bd462c2e20.r2.dev/transcoded-ads"
WINDOW_BUCKET_SECS = "2"
DECISION_TIMEOUT_MS = "2000"  # Increased to 2 seconds for database queries
SIGN_HOST = "pub-24423d0273094578a7f498bd462c2e20.r2.dev"
# Cache settings for HLS delivery (Safari compatibility)
SEGMENT_CACHE_MAX_AGE = "60"                             # Segments are immutable, cache longer
MANIFEST_CACHE_MAX_AGE = "4"                             # Manifests update frequently
# Dev/testing mode - allows access without JWT authentication (set to "0" for production)
DEV_ALLOW_NO_AUTH = "1"
# tokens & keys set as secrets: JWT_PUBLIC_KEY, SEGMENT_SECRET
# R2 configuration (set in .dev.vars for local, secrets for production)
R2_PUBLIC_URL = "https://pub-24423d0273094578a7f498bd462c2e20.r2.dev"
R2_ACCOUNT_ID = ""                                       # Set as secret
R2_ACCESS_KEY_ID = ""                                    # Set as secret
R2_SECRET_ACCESS_KEY = ""                                # Set as secret

# Observability
[observability]
enabled = true

# Sampling rates - set to 100% for debugging
[observability.logs]
enabled = true
head_sampling_rate = 1.0  # 100% of requests - full logging for debugging

[observability.traces]
enabled = true
head_sampling_rate = 1.0  # 100% of requests - full tracing for debugging